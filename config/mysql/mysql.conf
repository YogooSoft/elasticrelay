# MySQL configuration for ElasticRelay CDC
# 针对binlog CDC优化的MySQL配置

[mysqld]

#------------------------------------------------------------------------------
# GENERAL SETTINGS
#------------------------------------------------------------------------------

# 字符集设置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# SQL模式设置
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

# 时区设置
default-time-zone = '+8:00'

#------------------------------------------------------------------------------
# NETWORKING
#------------------------------------------------------------------------------

# 连接设置
max_connections = 500
max_user_connections = 450
max_connect_errors = 100000

# 超时设置
wait_timeout = 28800
interactive_timeout = 28800
connect_timeout = 10
net_read_timeout = 30
net_write_timeout = 60

# 网络缓冲区
max_allowed_packet = 256M
net_buffer_length = 32K

#------------------------------------------------------------------------------
# BINARY LOGGING (CDC关键配置)
#------------------------------------------------------------------------------

# 启用binlog
log-bin = mysql-binlog
binlog_format = ROW
binlog_row_image = FULL
binlog_row_metadata = FULL

# binlog文件管理
max_binlog_size = 1024M
binlog_expire_logs_seconds = 604800  # 7天
binlog_cache_size = 2M
binlog_stmt_cache_size = 2M

# 同步设置 (CDC建议设置)
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1

# GTID设置 (推荐用于CDC)
gtid_mode = ON
enforce_gtid_consistency = ON
log_slave_updates = ON

# binlog校验
binlog_checksum = CRC32
master_verify_checksum = ON
slave_sql_verify_checksum = ON

# 复制相关
server_id = 1
auto_increment_increment = 1
auto_increment_offset = 1

#------------------------------------------------------------------------------
# INNODB SETTINGS
#------------------------------------------------------------------------------

# 缓冲池设置
innodb_buffer_pool_size = 1G
innodb_buffer_pool_instances = 4
innodb_buffer_pool_chunk_size = 128M

# 日志设置
innodb_log_file_size = 512M
innodb_log_files_in_group = 2
innodb_log_buffer_size = 64M

# 刷写设置
innodb_flush_method = O_DIRECT
innodb_flush_neighbors = 0
innodb_flush_log_at_timeout = 1

# 并发设置
innodb_thread_concurrency = 0
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# 锁设置
innodb_lock_wait_timeout = 50
innodb_deadlock_detect = ON

#------------------------------------------------------------------------------
# QUERY CACHE (MySQL 5.7及以下)
#------------------------------------------------------------------------------

# MySQL 8.0已移除query cache，这些配置仅适用于旧版本
# query_cache_type = 1
# query_cache_size = 256M
# query_cache_limit = 8M

#------------------------------------------------------------------------------
# TABLE SETTINGS
#------------------------------------------------------------------------------

# 表设置
table_open_cache = 4096
table_definition_cache = 2048
open_files_limit = 65535

# 临时表设置
tmp_table_size = 256M
max_heap_table_size = 256M

#------------------------------------------------------------------------------
# THREAD SETTINGS
#------------------------------------------------------------------------------

# 线程设置
thread_cache_size = 50
thread_stack = 256K

#------------------------------------------------------------------------------
# PERFORMANCE SCHEMA
#------------------------------------------------------------------------------

# 性能监控
performance_schema = ON
performance_schema_max_table_instances = 12500
performance_schema_max_table_handles = 4000

#------------------------------------------------------------------------------
# SLOW QUERY LOG
#------------------------------------------------------------------------------

# 慢查询日志
slow_query_log = ON
slow_query_log_file = /var/lib/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = OFF
min_examined_row_limit = 100

#------------------------------------------------------------------------------
# ERROR LOG
#------------------------------------------------------------------------------

# 错误日志
log_error = /var/lib/mysql/error.log
log_error_verbosity = 2
log_timestamps = SYSTEM

#------------------------------------------------------------------------------
# GENERAL LOG (可选，用于调试)
#------------------------------------------------------------------------------

# 通用查询日志 (生产环境建议关闭)
general_log = OFF
general_log_file = /var/lib/mysql/general.log

#------------------------------------------------------------------------------
# CDC SPECIFIC OPTIMIZATIONS
#------------------------------------------------------------------------------

# CDC优化设置
transaction_isolation = READ-COMMITTED
# innodb_support_xa = ON  # MySQL 8.0 已移除此选项，XA支持默认启用

# 避免锁竞争
innodb_autoinc_lock_mode = 2
concurrent_insert = 2

# 减少磁盘I/O
innodb_change_buffering = all
innodb_adaptive_flushing = ON
innodb_adaptive_flushing_lwm = 10

# 内存优化
key_buffer_size = 32M
sort_buffer_size = 2M
read_buffer_size = 2M
read_rnd_buffer_size = 8M
myisam_sort_buffer_size = 64M

# 连接优化
back_log = 200
max_prepared_stmt_count = 16382

#------------------------------------------------------------------------------
# REPLICATION SETTINGS
#------------------------------------------------------------------------------

# 复制设置 (用于CDC)
relay_log_recovery = ON
relay_log_purge = ON
skip_slave_start = OFF

# 复制过滤 (可根据需要启用)
# binlog_do_db = elasticrelay
# replicate_do_db = elasticrelay

#------------------------------------------------------------------------------
# SECURITY SETTINGS
#------------------------------------------------------------------------------

# 安全设置
local_infile = OFF
secure_file_priv = /var/lib/mysql-files/

# 跳过DNS解析 (可选，提高连接速度)
# skip_name_resolve = ON

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
port = 3306
socket = /var/lib/mysql/mysql.sock
